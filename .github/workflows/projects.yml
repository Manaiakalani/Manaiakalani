name: Update Currently Building

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Generate project cards and update README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          mkdir -p dist
          python3 << 'PYEOF'
          import html, json, os, re, subprocess, textwrap

          owner = os.environ["OWNER"]

          result = subprocess.run(
              ["gh", "api", f"users/{owner}/repos?sort=pushed&direction=desc&per_page=10&type=owner"],
              capture_output=True, text=True,
          )
          repos = json.loads(result.stdout)
          repos = [
              r for r in repos
              if not r["fork"]
              and r["name"].lower() != owner.lower()
              and not r["private"]
          ][:3]

          LANG_COLORS = {
              "TypeScript": "#3178c6", "JavaScript": "#f1e05a", "Python": "#3572A5",
              "HTML": "#e34c26", "CSS": "#563d7c", "C++": "#f34b7d", "Go": "#00ADD8",
              "MDX": "#fcb32c", "Shell": "#89e051", "Java": "#b07219", "Ruby": "#701516",
              "Swift": "#F05138", "Rust": "#dea584",
          }

          THEMES = {
              "dark":  {"bg": "#0d1117", "border": "#30363d", "title": "#58a6ff", "desc": "#8b949e", "meta": "#8b949e"},
              "light": {"bg": "#ffffff", "border": "#d0d7de", "title": "#0969da", "desc": "#656d76", "meta": "#656d76"},
          }

          REPO_ICON = 'M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z'
          STAR_ICON = 'M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z'
          FORK_ICON = 'M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z'

          def generate_card(repo, theme_name):
              t = THEMES[theme_name]
              name = html.escape(repo["name"])
              desc = html.escape(repo.get("description") or "No description")
              lang = repo.get("language") or ""
              stars = repo.get("stargazers_count", 0)
              forks = repo.get("forks_count", 0)
              lang_color = LANG_COLORS.get(lang, t["meta"])

              lines = textwrap.wrap(desc, width=48)[:2]
              all_lines = textwrap.wrap(desc, width=48)
              if len(all_lines) > 2:
                  lines[-1] = lines[-1][:45] + "..."

              desc_svg = "\n".join(
                  f'    <text fill="{t["desc"]}" font-size="12" x="20" y="{50 + i * 16}">{line}</text>'
                  for i, line in enumerate(lines)
              )

              meta_y = 50 + len(lines) * 16 + 20
              h = meta_y + 20

              return f'''<svg xmlns="http://www.w3.org/2000/svg" width="400" height="{h}">
            <style>text {{ font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }}</style>
            <rect width="400" height="{h}" rx="6" fill="{t["bg"]}" stroke="{t["border"]}" stroke-width="1"/>
            <svg x="20" y="14" width="16" height="16" viewBox="0 0 16 16"><path fill="{t["meta"]}" d="{REPO_ICON}"/></svg>
            <text fill="{t["title"]}" font-size="14" font-weight="600" x="44" y="28">{name}</text>
          {desc_svg}
            <circle cx="26" cy="{meta_y}" r="6" fill="{lang_color}"/>
            <text fill="{t["meta"]}" font-size="12" x="38" y="{meta_y + 4}">{lang}</text>
            <svg x="150" y="{meta_y - 8}" width="16" height="16" viewBox="0 0 16 16"><path fill="{t["meta"]}" d="{STAR_ICON}"/></svg>
            <text fill="{t["meta"]}" font-size="12" x="170" y="{meta_y + 4}">{stars}</text>
            <svg x="200" y="{meta_y - 8}" width="16" height="16" viewBox="0 0 16 16"><path fill="{t["meta"]}" d="{FORK_ICON}"/></svg>
            <text fill="{t["meta"]}" font-size="12" x="220" y="{meta_y + 4}">{forks}</text>
          </svg>'''

          # Generate SVG cards for each repo in both themes
          for repo in repos:
              name = repo["name"]
              for theme in ("dark", "light"):
                  svg = generate_card(repo, theme)
                  with open(f"dist/{name}-{theme}.svg", "w") as f:
                      f.write(svg)
              print(f"  Generated cards for {name}")

          # Update README between markers
          owner_lower = owner.lower()
          readme_lines = ["<!-- CURRENTLY_BUILDING:START -->", '<div align="center">', ""]
          for i, repo in enumerate(repos):
              name = repo["name"]
              readme_lines.append(f'<a href="https://github.com/{owner}/{name}">')
              readme_lines.append(f'  <picture>')
              readme_lines.append(f'    <source media="(prefers-color-scheme: dark)" srcset="https://raw.githubusercontent.com/{owner_lower}/{owner_lower}/projects/{name}-dark.svg" />')
              readme_lines.append(f'    <source media="(prefers-color-scheme: light)" srcset="https://raw.githubusercontent.com/{owner_lower}/{owner_lower}/projects/{name}-light.svg" />')
              readme_lines.append(f'    <img src="https://raw.githubusercontent.com/{owner_lower}/{owner_lower}/projects/{name}-dark.svg" alt="{name}" />')
              readme_lines.append(f'  </picture>')
              readme_lines.append("</a>&nbsp;" if i % 2 == 0 else "</a>")
          readme_lines.extend(["", "</div>", "<!-- CURRENTLY_BUILDING:END -->"])
          new_section = "\n".join(readme_lines)

          with open("README.md", "r") as f:
              content = f.read()
          content = re.sub(
              r"<!-- CURRENTLY_BUILDING:START -->.*?<!-- CURRENTLY_BUILDING:END -->",
              new_section, content, flags=re.DOTALL,
          )
          with open("README.md", "w") as f:
              f.write(content)

          print(f"Updated README with {len(repos)} repos: {[r['name'] for r in repos]}")
          PYEOF

      - name: Push cards to projects branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: projects
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit README changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || (git commit -m "chore: update currently building section [skip ci]" && git push)
